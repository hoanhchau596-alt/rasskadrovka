<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–∞—Å–∫–∞–¥—Ä–æ–≤–∫–∞ ‚Äî Wedding Awards South</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Playfair+Display:wght@500;600&display=swap"
        rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-main: #2c2c24;
            --bg-card: #3d3d32;
            --bg-input: #4a4a3e;
            --bg-light: #d4cfc4;
            --accent: #c45a32;
            --accent-hover: #d4693f;
            --text-light: #f5f3ef;
            --text-dim: #a8a498;
            --text-dark: #2c2c24;
            --border: #5a5a4e;
        }

        /* –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞ ‚Äî –º–æ–ª–æ—á–Ω—ã–µ/–∫—Ä–µ–º–æ–≤—ã–µ –æ—Ç—Ç–µ–Ω–∫–∏ */
        [data-theme="light"] {
            --bg-main: #f8f5f0;
            --bg-card: #fffbf5;
            --bg-input: #f0ebe3;
            --bg-light: #e8e2d8;
            --accent: #c45a32;
            --accent-hover: #d4693f;
            --text-light: #3a3632;
            --text-dim: #6b6560;
            --text-dark: #2c2c24;
            --border: #d4cfc4;
        }

        /* –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ç–µ–º—ã */
        .theme-toggle {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .theme-toggle:hover {
            border-color: var(--accent);
        }

        .theme-toggle-text {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-dim);
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg-main);
            color: var(--text-light);
            line-height: 1.6;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 60px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            position: sticky;
            top: 0;
            background: var(--bg-main);
            z-index: 100;
        }

        .logo {
            font-family: 'Playfair Display', serif;
            font-size: 24px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            font-family: inherit;
            transition: all 0.2s;
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-light);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-input);
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        /* Hero Section */
        .hero {
            padding: 40px;
            max-width: 1400px;
            margin: 32px auto;
            margin-left: 60px;
            margin-right: 60px;
            max-width: calc(100% - 120px);
            background: var(--bg-card);
            border: 3px solid var(--border);
            border-radius: 16px;
        }

        .hero h1 {
            font-family: 'Playfair Display', serif;
            font-size: 48px;
            font-weight: 500;
            line-height: 1.15;
            margin-bottom: 16px;
        }

        .hero h1 span {
            text-decoration: underline;
            text-decoration-color: var(--accent);
            text-underline-offset: 4px;
        }

        .project-title-input {
            font-family: 'Playfair Display', serif;
            font-size: clamp(28px, 5vw, 56px);
            font-weight: 500;
            background: transparent;
            border: none;
            color: var(--text-light);
            width: 100%;
            outline: none;
            border-bottom: 2px solid transparent;
            transition: border-color 0.2s;
            resize: none;
            overflow: hidden;
            line-height: 1.2;
            min-height: 1.2em;
            word-wrap: break-word;
            white-space: pre-wrap;
        }

        .project-title-input:focus {
            border-bottom-color: var(--accent);
        }

        .hero-meta {
            display: flex;
            gap: 40px;
            font-size: 18px;
            color: var(--text-dim);
            margin-top: 28px;
            align-items: center;
        }

        .hero-meta div {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .dot {
            width: 10px;
            height: 10px;
            background: var(--accent);
            border-radius: 50%;
        }

        .duration-edit-input {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 6px 12px;
            color: var(--text-light);
            font-size: 18px;
            font-family: inherit;
            width: 80px;
            text-align: center;
        }

        .duration-edit-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .project-types {
            display: flex;
            gap: 16px;
        }

        .type-checkbox {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            color: var(--text-dim);
            font-size: 16px;
        }

        .type-checkbox input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--accent);
            cursor: pointer;
        }

        .type-checkbox:has(input:checked) {
            color: var(--text-light);
        }

        /* Characters Section */
        .characters-section {
            margin-top: 32px;
            padding: 20px;
            background: var(--bg-card);
            border-radius: 12px;
        }

        .characters-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .section-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-dim);
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .characters-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .character-item {
            display: grid;
            grid-template-columns: 80px 150px 1fr 40px;
            gap: 12px;
            align-items: start;
            padding: 12px;
            background: var(--bg-input);
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .character-item input,
        .character-item textarea {
            background: var(--bg-main);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px 10px;
            color: var(--text-light);
            font-size: 13px;
            font-family: inherit;
        }

        .character-item input:focus,
        .character-item textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        .character-item textarea {
            min-height: 60px;
            resize: vertical;
        }

        .character-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--accent);
            padding: 8px 0;
        }

        .character-remove {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-dim);
            border-radius: 6px;
            padding: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .character-remove:hover {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .characters-empty {
            color: var(--text-dim);
            font-size: 13px;
            font-style: italic;
            padding: 12px;
            text-align: center;
        }

        /* Characters in Scene */
        .characters-in-scene .characters-checkboxes {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .character-checkbox {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .character-checkbox:hover {
            border-color: var(--accent);
        }

        .character-checkbox input {
            accent-color: var(--accent);
        }

        .character-checkbox input:checked+span {
            color: var(--accent);
            font-weight: 500;
        }

        .no-characters {
            color: var(--text-dim);
            font-size: 12px;
            font-style: italic;
        }

        /* Toolbar */
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 60px 24px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .section-title {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-dim);
        }

        /* Scenes Container */
        .scenes {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 60px 80px;
        }

        /* Scene Card - NEW LAYOUT */
        .scene {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 32px;
            padding: 32px;
            background: var(--bg-card);
            border-radius: 16px;
            border: 3px solid var(--border);
            transition: border-color 0.2s;
        }

        .scene:hover {
            border-color: var(--accent);
        }

        /* –®–∞–ø–∫–∞: –±–µ–π–¥–∂ | –Ω–∞–∑–≤–∞–Ω–∏–µ | –º–µ—Ç–∞ | –∫–Ω–æ–ø–∫–∏ */
        .scene-header-row {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .scene-badge {
            background: var(--accent);
            color: white;
            font-size: 16px;
            font-weight: 700;
            padding: 8px 18px;
            border-radius: 8px;
            flex-shrink: 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .scene-title-input {
            font-family: 'Playfair Display', serif;
            font-size: 20px;
            font-weight: 500;
            background: transparent;
            border: none;
            color: var(--text-light);
            flex: 1;
            min-width: 200px;
            outline: none;
            padding: 4px 0;
            border-bottom: 1px solid transparent;
        }

        .scene-title-input:focus {
            border-bottom-color: var(--accent);
        }

        .scene-meta-inline {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .meta-field {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .meta-field label {
            font-size: 14px;
        }

        .meta-field input,
        .meta-field select {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 6px 10px;
            color: var(--text-light);
            font-size: 13px;
        }

        .duration-input {
            width: 60px;
        }

        .characters-inline {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .characters-checkboxes {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .character-checkbox {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            color: var(--text-dim);
            cursor: pointer;
        }

        .character-checkbox input {
            width: 14px;
            height: 14px;
        }

        .no-characters {
            font-size: 11px;
            color: var(--text-dim);
        }

        .scene-actions {
            display: flex;
            gap: 6px;
            margin-left: auto;
        }

        .scene-btn {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .scene-btn:hover {
            border-color: var(--accent);
        }

        /* –°–µ—Ä–µ–¥–∏–Ω–∞: –∫–∞—Ä—Ç–∏–Ω–∫–∞ 75% + –æ–ø–∏—Å–∞–Ω–∏–µ 25% */
        .scene-middle-row {
            display: flex;
            gap: 20px;
        }

        .scene-image-container {
            flex: 0 0 60%;
            position: relative;
        }

        .scene-image-dropzone {
            aspect-ratio: 16/9;
            background: var(--bg-main);
            border: 2px dashed var(--border);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        .scene-image-dropzone:hover {
            border-color: var(--accent);
        }

        .scene-image-dropzone.has-image {
            border: none;
        }

        .dropzone-content {
            text-align: center;
            color: var(--text-dim);
        }

        .dropzone-icon {
            font-size: 36px;
            margin-bottom: 8px;
        }

        .scene-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 12px;
        }

        .remove-image {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(196, 90, 50, 0.9);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .scene-image-dropzone:hover .remove-image {
            display: flex;
        }

        .scene-description-side {
            flex: 0 0 40%;
            display: flex;
            flex-direction: column;
        }

        .scene-description-side .description-input {
            flex: 1;
            min-height: 120px;
            background: var(--bg-input);
            color: var(--text-light);
            font-size: 16px;
        }

        /* –ù–∏–∑: –¥–∏–∞–ª–æ–≥ + –∑–∞–º–µ—Ç–∫–∏ */
        .scene-bottom-row {
            display: flex;
            gap: 20px;
        }

        .field-dialogue {
            flex: 2;
        }

        .field-notes {
            flex: 1;
        }

        .field {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .field-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-dim);
        }

        .field textarea {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            color: var(--text-light);
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            min-height: 60px;
            line-height: 1.5;
        }

        .field textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        .field textarea.dialogue {
            background: var(--bg-main);
            border-left: 4px solid var(--accent);
            font-style: italic;
            min-height: 160px;
            font-size: 18px;
            padding: 16px;
        }

        /* Auto-expand textareas */
        .field textarea {
            overflow: hidden;
            resize: none;
        }

        /* AI Prompt Field */
        .prompt-field {
            margin-top: 8px;
            padding-top: 12px;
            border-top: 1px dashed var(--border);
        }

        .prompt-field .field-label {
            font-size: 10px;
            color: #7a7a6e;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .prompt-field .field-label::before {
            content: 'ü§ñ';
        }

        .prompt-field textarea {
            font-size: 11px;
            min-height: 50px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px dashed var(--border);
            color: #8a8a7e;
            font-family: 'Monaco', 'Consolas', monospace;
        }

        .prompt-field textarea:focus {
            color: var(--text-light);
            border-color: var(--accent);
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            z-index: 1000;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        /* Responsive */
        @media (max-width: 1000px) {
            .header {
                padding: 16px 24px;
            }

            .hero {
                padding: 40px 24px;
            }

            .toolbar {
                padding: 0 24px 16px;
            }

            .scenes {
                padding: 0 24px 40px;
            }

            .scene {
                grid-template-columns: 1fr;
                padding: 20px;
            }
        }

        /* Hidden file input */
        .hidden {
            display: none;
        }
    </style>
</head>

<body>
    <header class="header">
        <div class="logo">üé¨ Storyboard</div>
        <div class="header-actions">
            <button class="theme-toggle" id="themeToggle" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">
                <span class="theme-icon">üåô</span>
                <span class="theme-toggle-text">–¢—ë–º–Ω–∞—è</span>
            </button>
            <button class="btn btn-secondary" id="resetDefault" title="–°–±—Ä–æ—Å–∏—Ç—å –∫ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º —Å—Ü–µ–Ω–∞–º">üîÑ –°–±—Ä–æ—Å</button>
            <button class="btn btn-secondary" id="loadProject">üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
            <button class="btn btn-secondary" id="saveProject">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button class="btn btn-primary" id="exportHTML">üìÑ –≠–∫—Å–ø–æ—Ä—Ç</button>
            <button class="btn btn-primary" id="printVersion">üìÑ PDF</button>
        </div>
    </header>

    <section class="hero">
        <textarea class="project-title-input" id="projectTitle" rows="1" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞..."></textarea>
        <div class="hero-meta">
            <div><span class="dot"></span> <span id="sceneCount">0</span> —Å—Ü–µ–Ω</div>
            <div><span class="dot"></span> <input type="text" class="duration-edit-input" id="totalDuration"
                    value="0:00" placeholder="0:00"> —Ö—Ä–æ–Ω–æ–º–µ—Ç—Ä–∞–∂</div>
            <div class="project-types">
                <label class="type-checkbox"><input type="checkbox" id="typeStatic" checked> <span class="dot"></span>
                    –°—Ç–∞—Ç–∏—á–Ω—ã–µ –∫–∞–¥—Ä—ã</label>
                <label class="type-checkbox"><input type="checkbox" id="typeDynamic"> <span class="dot"></span>
                    –î–∏–Ω–∞–º–∏–∫–∞</label>
            </div>
        </div>

        <!-- –°–µ–∫—Ü–∏—è –ì–µ—Ä–æ–∏ -->
        <div class="characters-section">
            <div class="characters-header">
                <span class="section-label">üë§ –ì–µ—Ä–æ–∏</span>
                <button class="btn btn-small" id="addCharacter">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
            <div class="characters-list" id="charactersList"></div>
        </div>
    </section>

    <div class="toolbar">
        <div class="section-title">–°—Ü–µ–Ω—ã</div>
        <button class="btn btn-primary" id="addScene">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å—Ü–µ–Ω—É</button>
    </div>

    <main class="scenes" id="scenesContainer"></main>

    <div class="toast" id="toast">
        <span class="toast-icon"></span>
        <span class="toast-message"></span>
    </div>

    <input type="file" id="loadProjectInput" accept=".json" class="hidden">

    <script>
        let scenes = [];
        let characters = [];

        const scenesContainer = document.getElementById('scenesContainer');
        const projectTitleEl = document.getElementById('projectTitle');
        const sceneCountEl = document.getElementById('sceneCount');
        const totalDurationEl = document.getElementById('totalDuration');
        const charactersListEl = document.getElementById('charactersList');

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadTheme();
            loadFromLocalStorage();
            if (scenes.length === 0) {
                loadDefaultScenes();
            }
            renderAllScenes();
            renderCharacters();
        });

        // ===== THEME FUNCTIONS =====
        function loadTheme() {
            const savedTheme = localStorage.getItem('storyboard_theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeButton(savedTheme);
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'dark';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('storyboard_theme', newTheme);
            updateThemeButton(newTheme);
        }

        function updateThemeButton(theme) {
            const icon = document.querySelector('.theme-icon');
            const text = document.querySelector('.theme-toggle-text');
            if (theme === 'light') {
                icon.textContent = '‚òÄÔ∏è';
                text.textContent = '–°–≤–µ—Ç–ª–∞—è';
            } else {
                icon.textContent = 'üåô';
                text.textContent = '–¢—ë–º–Ω–∞—è';
            }
        }

        document.getElementById('themeToggle').addEventListener('click', toggleTheme);

        // Event Listeners
        document.getElementById('addScene').addEventListener('click', addScene);
        document.getElementById('addCharacter').addEventListener('click', addCharacter);
        document.getElementById('saveProject').addEventListener('click', saveProject);
        document.getElementById('loadProject').addEventListener('click', () => document.getElementById('loadProjectInput').click());
        document.getElementById('loadProjectInput').addEventListener('change', loadProject);
        document.getElementById('exportHTML').addEventListener('click', exportHTML);
        document.getElementById('printVersion').addEventListener('click', printVersion);
        document.getElementById('resetDefault').addEventListener('click', () => {
            if (confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ —Å—Ü–µ–Ω—ã –∫ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º? –¢–µ–∫—É—â–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã!')) {
                localStorage.removeItem('storyboard_v2');
                loadDefaultScenes();
                characters = [];
                renderCharacters();
                renderAllScenes();
                showToast('–°–±—Ä–æ—à–µ–Ω–æ –∫ –¥–µ—Ñ–æ–ª—Ç—É');
            }
        });
        projectTitleEl.addEventListener('input', saveToLocalStorage);
        document.getElementById('typeStatic').addEventListener('change', saveToLocalStorage);
        document.getElementById('typeDynamic').addEventListener('change', saveToLocalStorage);
        projectTitleEl.addEventListener('input', function () {
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';
        });
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—ã—Å–æ—Ç—ã –∑–∞–≥–æ–ª–æ–≤–∫–∞
        setTimeout(() => {
            projectTitleEl.style.height = 'auto';
            projectTitleEl.style.height = projectTitleEl.scrollHeight + 'px';
        }, 100);

        // ===== CHARACTERS FUNCTIONS =====

        function addCharacter() {
            const character = {
                id: Date.now(),
                name: '',
                description: ''
            };
            characters.push(character);
            renderCharacters();
            renderAllScenes(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ü–µ–Ω—ã –¥–ª—è –Ω–æ–≤—ã—Ö —á–µ–∫–±–æ–∫—Å–æ–≤
            saveToLocalStorage();
            showToast('–ì–µ—Ä–æ–π –¥–æ–±–∞–≤–ª–µ–Ω');
        }

        function removeCharacter(id) {
            characters = characters.filter(c => c.id !== id);
            renderCharacters();
            renderAllScenes(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ü–µ–Ω—ã
            saveToLocalStorage();
            showToast('–ì–µ—Ä–æ–π —É–¥–∞–ª—ë–Ω');
        }

        function renderCharacters() {
            if (characters.length === 0) {
                charactersListEl.innerHTML = '<div class="characters-empty">–î–æ–±–∞–≤—å—Ç–µ –≥–µ—Ä–æ–µ–≤ –¥–ª—è –æ–ø–∏—Å–∞–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π</div>';
                return;
            }

            charactersListEl.innerHTML = '';
            characters.forEach((char, index) => {
                const item = document.createElement('div');
                item.className = 'character-item';
                item.innerHTML = `
                    <div class="character-label">–ì–µ—Ä–æ–π ${index + 1}</div>
                    <input type="text" class="char-name" value="${char.name}" placeholder="–ò–º—è...">
                    <textarea class="char-description" placeholder="–î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ: –∫–æ—Å—Ç—é–º, –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã, –≤–Ω–µ—à–Ω–æ—Å—Ç—å...">${char.description}</textarea>
                    <button class="character-remove" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
                `;

                item.querySelector('.char-name').addEventListener('input', (e) => {
                    char.name = e.target.value;
                    saveToLocalStorage();
                });

                item.querySelector('.char-description').addEventListener('input', (e) => {
                    char.description = e.target.value;
                    saveToLocalStorage();
                });

                item.querySelector('.character-remove').addEventListener('click', () => removeCharacter(char.id));

                charactersListEl.appendChild(item);
            });
        }

        // Default scenes
        function loadDefaultScenes() {
            scenes = [
                { id: 1, title: "", description: "", dialogue: "", duration: "0:00", shotType: "", notes: "", prompt: "", image: "" },
                { id: 2, title: "", description: "", dialogue: "", duration: "0:00", shotType: "", notes: "", prompt: "", image: "" },
                { id: 3, title: "", description: "", dialogue: "", duration: "0:00", shotType: "", notes: "", prompt: "", image: "" },
                { id: 4, title: "", description: "", dialogue: "", duration: "0:00", shotType: "", notes: "", prompt: "", image: "" },
                { id: 5, title: "", description: "", dialogue: "", duration: "0:00", shotType: "", notes: "", prompt: "", image: "" },
                { id: 6, title: "", description: "", dialogue: "", duration: "0:00", shotType: "", notes: "", prompt: "", image: "" },
                { id: 7, title: "", description: "", dialogue: "", duration: "0:00", shotType: "", notes: "", prompt: "", image: "" },
                { id: 8, title: "", description: "", dialogue: "", duration: "0:00", shotType: "", notes: "", prompt: "", image: "" },
                { id: 9, title: "", description: "", dialogue: "", duration: "0:00", shotType: "", notes: "", prompt: "", image: "" },
                { id: 10, title: "", description: "", dialogue: "", duration: "0:00", shotType: "", notes: "", prompt: "", image: "" }
            ];
            projectTitleEl.value = "–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞";
            saveToLocalStorage();
        }

        function renderAllScenes() {
            scenesContainer.innerHTML = '';
            scenes.forEach((scene, index) => renderScene(scene, index + 1));
            updateMeta();
        }

        function renderScene(scene, index) {
            const card = document.createElement('article');
            card.className = 'scene';
            card.dataset.id = scene.id;

            const shotTypes = {
                'wide': '–û–±—â–∏–π –ø–ª–∞–Ω',
                'medium': '–°—Ä–µ–¥–Ω–∏–π –ø–ª–∞–Ω',
                'close': '–ö—Ä—É–ø–Ω—ã–π –ø–ª–∞–Ω',
                'extreme-close': '–î–µ—Ç–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω',
                'pov': '–û—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞',
                'top-down': '–í–∏–¥ —Å–≤–µ—Ä—Ö—É'
            };

            card.innerHTML = `
                <!-- –®–ê–ü–ö–ê: –ù–∞–∑–≤–∞–Ω–∏–µ | –¢–∞–π–º–∫–æ–¥ | –ü–ª–∞–Ω | –ì–µ—Ä–æ–∏ | –ö–Ω–æ–ø–∫–∏ -->
                <div class="scene-header-row">
                    <span class="scene-badge">–°—Ü–µ–Ω–∞ ${index}</span>
                    <input type="text" class="scene-title-input" value="${scene.title}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ü–µ–Ω—ã...">
                    <div class="scene-meta-inline">
                        <div class="meta-field">
                            <label>‚è±</label>
                            <input type="text" class="duration-input" value="${scene.duration || '0:00'}" placeholder="0:00">
                        </div>
                        <div class="meta-field">
                            <label>üì∑</label>
                            <select class="shot-type-select">
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ...</option>
                                ${Object.entries(shotTypes).map(([val, label]) =>
                `<option value="${val}" ${scene.shotType === val ? 'selected' : ''}>${label}</option>`
            ).join('')}
                            </select>
                        </div>
                        <div class="meta-field characters-inline">
                            <label>üë§</label>
                            <div class="characters-checkboxes">
                                ${characters.length === 0
                    ? '<span class="no-characters">–ù–µ—Ç –≥–µ—Ä–æ–µ–≤</span>'
                    : characters.map((char, i) => `
                                        <label class="character-checkbox">
                                            <input type="checkbox" value="${char.id}" ${(scene.charactersInScene || []).includes(char.id) ? 'checked' : ''}>
                                            <span>${char.name || '–ì–µ—Ä–æ–π ' + (i + 1)}</span>
                                        </label>
                                    `).join('')
                }
                            </div>
                        </div>
                    </div>
                    <div class="scene-actions">
                        <button class="scene-btn move-up" title="–í–≤–µ—Ä—Ö">‚¨ÜÔ∏è</button>
                        <button class="scene-btn move-down" title="–í–Ω–∏–∑">‚¨áÔ∏è</button>
                        <button class="scene-btn duplicate" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å">üìã</button>
                        <button class="scene-btn delete" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
                    </div>
                </div>

                <!-- –°–ï–†–ï–î–ò–ù–ê: –ö–∞—Ä—Ç–∏–Ω–∫–∞ (75%) + –û–ø–∏—Å–∞–Ω–∏–µ (25%) -->
                <div class="scene-middle-row">
                    <div class="scene-image-container">
                        <div class="scene-image-dropzone ${scene.image ? 'has-image' : ''}">
                            <input type="file" class="image-input hidden" accept="image/*">
                            <div class="dropzone-content" ${scene.image ? 'style="display:none"' : ''}>
                                <div class="dropzone-icon">üñºÔ∏è</div>
                                <div>–ù–∞–∂–º–∏—Ç–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ</div>
                            </div>
                            <img class="scene-image" src="${scene.image || ''}" ${scene.image ? '' : 'style="display:none"'}>
                            <button class="remove-image" ${scene.image ? '' : 'style="display:none"'}>‚úï</button>
                        </div>
                    </div>
                    <div class="scene-description-side">
                        <div class="field-label">–û–ø–∏—Å–∞–Ω–∏–µ</div>
                        <textarea class="description-input" placeholder="–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ –∫–∞–¥—Ä–µ...">${scene.description || ''}</textarea>
                    </div>
                </div>

                <!-- –ù–ò–ó: –î–∏–∞–ª–æ–≥ | –ó–∞–º–µ—Ç–∫–∏ -->
                <div class="scene-bottom-row">
                    <div class="field field-dialogue">
                        <div class="field-label">–î–∏–∞–ª–æ–≥–∏ / –ó–∞–∫–∞–¥—Ä–æ–≤—ã–π —Ç–µ–∫—Å—Ç</div>
                        <textarea class="dialogue-input dialogue" placeholder="–¢–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –∑–≤—É—á–∏—Ç...">${scene.dialogue || ''}</textarea>
                    </div>
                    <div class="field field-notes">
                        <div class="field-label">–ó–∞–º–µ—Ç–∫–∏</div>
                        <textarea class="notes-input" placeholder="–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∑–∞–º–µ—Ç–∫–∏...">${scene.notes || ''}</textarea>
                    </div>
                </div>
                <!-- –ü–†–û–ú–ü–¢ -->
                <div class="field prompt-field">
                    <div class="field-label">–ü—Ä–æ–º–ø—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</div>
                    <textarea class="prompt-input" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è AI-–≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞...">${scene.prompt || ''}</textarea>
                </div>
            `;

            setupSceneEvents(card, scene);
            scenesContainer.appendChild(card);

            // –ê–≤—Ç–æ-—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –≤—Å–µ—Ö textarea –ø–æ–¥ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
            card.querySelectorAll('textarea').forEach(autoExpand);
        }

        function autoExpand(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
            textarea.addEventListener('input', function () {
                this.style.height = 'auto';
                this.style.height = this.scrollHeight + 'px';
            });
        }

        // Init App
        // Init App
        document.addEventListener('DOMContentLoaded', () => {
            loadTheme();
            loadFromLocalStorage();
            if (scenes.length === 0) {
                loadDefaultScenes();
            }
            renderAllScenes();
            renderCharacters();
        });

        function setupSceneEvents(card, scene) {
            const dropzone = card.querySelector('.scene-image-dropzone');
            const fileInput = card.querySelector('.image-input');
            const imageEl = card.querySelector('.scene-image');
            const removeBtn = card.querySelector('.remove-image');
            const dropzoneContent = card.querySelector('.dropzone-content');

            dropzone.addEventListener('click', (e) => {
                if (!e.target.closest('.remove-image')) fileInput.click();
            });

            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        scene.image = e.target.result;
                        imageEl.src = e.target.result;
                        imageEl.style.display = 'block';
                        removeBtn.style.display = 'flex';
                        dropzoneContent.style.display = 'none';
                        dropzone.classList.add('has-image');
                        saveToLocalStorage();
                    };
                    reader.readAsDataURL(file);
                }
            });

            dropzone.addEventListener('dragover', (e) => { e.preventDefault(); dropzone.style.borderColor = 'var(--accent)'; });
            dropzone.addEventListener('dragleave', () => { dropzone.style.borderColor = ''; });
            dropzone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropzone.style.borderColor = '';
                const file = e.dataTransfer.files[0];
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        scene.image = ev.target.result;
                        imageEl.src = ev.target.result;
                        imageEl.style.display = 'block';
                        removeBtn.style.display = 'flex';
                        dropzoneContent.style.display = 'none';
                        dropzone.classList.add('has-image');
                        saveToLocalStorage();
                    };
                    reader.readAsDataURL(file);
                }
            });

            removeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                scene.image = null;
                imageEl.src = '';
                imageEl.style.display = 'none';
                removeBtn.style.display = 'none';
                dropzoneContent.style.display = '';
                dropzone.classList.remove('has-image');
                saveToLocalStorage();
            });

            card.querySelector('.scene-title-input').addEventListener('input', (e) => { scene.title = e.target.value; saveToLocalStorage(); });
            card.querySelector('.duration-input').addEventListener('input', (e) => { scene.duration = e.target.value; saveToLocalStorage(); updateMeta(); });
            card.querySelector('.shot-type-select').addEventListener('change', (e) => { scene.shotType = e.target.value; saveToLocalStorage(); });
            card.querySelector('.description-input').addEventListener('input', (e) => { scene.description = e.target.value; saveToLocalStorage(); });
            card.querySelector('.dialogue-input').addEventListener('input', (e) => { scene.dialogue = e.target.value; saveToLocalStorage(); });
            card.querySelector('.notes-input').addEventListener('input', (e) => { scene.notes = e.target.value; saveToLocalStorage(); });
            card.querySelector('.prompt-input').addEventListener('input', (e) => { scene.prompt = e.target.value; saveToLocalStorage(); });

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –≥–µ—Ä–æ–µ–≤ –≤ —Å—Ü–µ–Ω–µ
            card.querySelectorAll('.character-checkbox input').forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    if (!scene.charactersInScene) scene.charactersInScene = [];
                    const charId = parseInt(checkbox.value);
                    if (checkbox.checked) {
                        if (!scene.charactersInScene.includes(charId)) {
                            scene.charactersInScene.push(charId);
                        }
                    } else {
                        scene.charactersInScene = scene.charactersInScene.filter(id => id !== charId);
                    }
                    saveToLocalStorage();
                });
            });

            card.querySelector('.move-up').addEventListener('click', () => moveScene(scene.id, -1));
            card.querySelector('.move-down').addEventListener('click', () => moveScene(scene.id, 1));
            card.querySelector('.duplicate').addEventListener('click', () => duplicateScene(scene.id));
            card.querySelector('.delete').addEventListener('click', () => deleteScene(scene.id));
        }

        function addScene() {
            const scene = { id: Date.now(), title: '', description: '', dialogue: '', duration: '0:00', shotType: '', notes: '', prompt: '', charactersInScene: [], image: null };
            scenes.push(scene);
            renderAllScenes();
            saveToLocalStorage();
            showToast('–°—Ü–µ–Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞');
        }

        function moveScene(id, direction) {
            const index = scenes.findIndex(s => s.id === id);
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= scenes.length) return;
            [scenes[index], scenes[newIndex]] = [scenes[newIndex], scenes[index]];
            renderAllScenes();
            saveToLocalStorage();
        }

        function duplicateScene(id) {
            const scene = scenes.find(s => s.id === id);
            const index = scenes.findIndex(s => s.id === id);
            const newScene = { ...scene, id: Date.now(), title: scene.title + ' (–∫–æ–ø–∏—è)' };
            scenes.splice(index + 1, 0, newScene);
            renderAllScenes();
            saveToLocalStorage();
            showToast('–°—Ü–µ–Ω–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∞');
        }

        function deleteScene(id) {
            scenes = scenes.filter(s => s.id !== id);
            renderAllScenes();
            saveToLocalStorage();
            showToast('–°—Ü–µ–Ω–∞ —É–¥–∞–ª–µ–Ω–∞');
        }

        function updateMeta() {
            sceneCountEl.textContent = scenes.length;
            let totalSeconds = 0;
            scenes.forEach(s => {
                if (s.duration) {
                    const parts = s.duration.split(':');
                    if (parts.length === 2) {
                        totalSeconds += parseInt(parts[0] || 0) * 60 + parseInt(parts[1] || 0);
                    }
                }
            });
            const mins = Math.floor(totalSeconds / 60);
            const secs = totalSeconds % 60;
            totalDurationEl.value = `${mins}:${String(secs).padStart(2, '0')}`;
        }

        // ===== PERSISTENCE =====

        function saveToLocalStorage() {
            const projectTypes = {
                static: document.getElementById('typeStatic').checked,
                dynamic: document.getElementById('typeDynamic').checked
            };
            localStorage.setItem('storyboard_v2', JSON.stringify({ title: projectTitleEl.value, scenes, characters, projectTypes }));
        }

        function loadFromLocalStorage() {
            const data = localStorage.getItem('storyboard_v2');
            if (data) {
                const parsed = JSON.parse(data);
                projectTitleEl.value = parsed.title || '';
                scenes = parsed.scenes || [];
                characters = parsed.characters || [];
                if (parsed.projectTypes) {
                    document.getElementById('typeStatic').checked = parsed.projectTypes.static !== false;
                    document.getElementById('typeDynamic').checked = parsed.projectTypes.dynamic === true;
                }
            }
        }

        function saveProject() {
            const data = { title: projectTitleEl.value, scenes, characters, exportedAt: new Date().toISOString() };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${projectTitleEl.value || 'storyboard'}.json`;
            a.click();
            showToast('–ü—Ä–æ–µ–∫—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
        }

        function loadProject(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    projectTitleEl.value = data.title || '';
                    scenes = data.scenes || [];
                    characters = data.characters || [];
                    renderAllScenes();
                    renderCharacters();
                    saveToLocalStorage();
                    showToast('–ü—Ä–æ–µ–∫—Ç –∑–∞–≥—Ä—É–∂–µ–Ω');
                } catch (err) {
                    showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
                }
            };
            reader.readAsText(file);
        }

        function exportHTML() {
            // Export static HTML version
            let html = `<!DOCTYPE html><html lang="ru"><head><meta charset="UTF-8"><title>${projectTitleEl.value}</title><style>body{font-family:Arial,sans-serif;max-width:900px;margin:0 auto;padding:40px;background:#2c2c24;color:#f5f3ef}h1{text-align:center;margin-bottom:40px}.scene{margin-bottom:40px;background:#3d3d32;padding:24px;border-radius:12px}.scene-header{font-size:20px;font-weight:bold;margin-bottom:12px;color:#c45a32}.scene-image{max-width:100%;border-radius:8px;margin-bottom:16px}.field{margin-bottom:12px}.field-label{font-size:12px;color:#a8a498;text-transform:uppercase;margin-bottom:4px}.dialogue{background:#2c2c24;padding:12px;border-left:3px solid #c45a32;border-radius:0 8px 8px 0;font-style:italic}</style></head><body><h1>${projectTitleEl.value}</h1>`;
            scenes.forEach((s, i) => {
                html += `<div class="scene"><div class="scene-header">–°—Ü–µ–Ω–∞ ${i + 1}: ${s.title}</div>`;
                if (s.image) html += `<img class="scene-image" src="${s.image}">`;
                if (s.description) html += `<div class="field"><div class="field-label">–û–ø–∏—Å–∞–Ω–∏–µ</div><div>${s.description}</div></div>`;
                if (s.dialogue) html += `<div class="field"><div class="field-label">–î–∏–∞–ª–æ–≥</div><div class="dialogue">${s.dialogue.replace(/\n/g, '<br>')}</div></div>`;
                if (s.duration) html += `<div class="field"><div class="field-label">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</div><div>${s.duration}</div></div>`;
                if (s.notes) html += `<div class="field"><div class="field-label">–ó–∞–º–µ—Ç–∫–∏</div><div>${s.notes}</div></div>`;
                html += `</div>`;
            });
            html += `</body></html>`;
            const blob = new Blob([html], { type: 'text/html' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${projectTitleEl.value || 'storyboard'}.html`;
            a.click();
            showToast('–≠–∫—Å–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω');
        }

        function printVersion() {
            const shotTypes = {
                'wide': '–û–±—â–∏–π –ø–ª–∞–Ω',
                'medium': '–°—Ä–µ–¥–Ω–∏–π –ø–ª–∞–Ω',
                'close': '–ö—Ä—É–ø–Ω—ã–π –ø–ª–∞–Ω',
                'extreme-close': '–î–µ—Ç–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω',
                'pov': '–û—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞',
                'top-down': '–í–∏–¥ —Å–≤–µ—Ä—Ö—É'
            };

            let html = `<!DOCTYPE html><html lang="ru"><head><meta charset="UTF-8"><title>${projectTitleEl.value} ‚Äî PDF</title>
            <style>
                @page { size: A4 landscape; margin: 10mm; }
                * { box-sizing: border-box; margin: 0; padding: 0; }
                body { font-family: Arial, sans-serif; color: #333; font-size: 12px; }
                
                .page { 
                    page-break-after: always; 
                    width: 277mm; 
                    height: 190mm; 
                    padding: 10px;
                    display: flex;
                    flex-direction: column;
                }
                .page:last-child { page-break-after: auto; }
                
                /* –û–±–ª–æ–∂–∫–∞ */
                .cover { 
                    justify-content: center; 
                    align-items: center; 
                    text-align: center;
                }
                .cover h1 { font-size: 36px; margin-bottom: 20px; color: #c45a32; }
                .cover .meta { font-size: 16px; color: #666; }
                
                /* –ö–∞—Ä—Ç–æ—á–∫–∞ —Å—Ü–µ–Ω—ã */
                .scene-card {
                    display: flex;
                    flex-direction: column;
                    height: 100%;
                    gap: 12px;
                    padding: 20px;
                    border: 3px solid #5a5a4e;
                    border-radius: 12px;
                    background: #f8f5f0;
                }
                
                /* –®–∞–ø–∫–∞: –Ω–æ–º–µ—Ä + –Ω–∞–∑–≤–∞–Ω–∏–µ + –º–µ—Ç–∞ */
                .scene-header {
                    display: flex;
                    align-items: center;
                    gap: 16px;
                    padding-bottom: 12px;
                    border-bottom: 2px solid #d4cfc4;
                }
                .scene-badge {
                    background: #c45a32;
                    color: white;
                    font-size: 14px;
                    font-weight: bold;
                    padding: 8px 16px;
                    border-radius: 8px;
                    text-transform: uppercase;
                }
                .scene-title {
                    font-size: 20px;
                    font-weight: bold;
                    color: #c45a32;
                    flex: 1;
                }
                .scene-meta {
                    display: flex;
                    gap: 20px;
                    font-size: 12px;
                    color: #666;
                }
                
                /* –°–µ—Ä–µ–¥–∏–Ω–∞: –∫–∞—Ä—Ç–∏–Ω–∫–∞ 60% + –æ–ø–∏—Å–∞–Ω–∏–µ 40% */
                .scene-middle {
                    display: flex;
                    gap: 16px;
                    flex: 1;
                    min-height: 0;
                }
                .scene-image-wrap {
                    flex: 0 0 60%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    background: #e8e2d8;
                    border: 2px dashed #d4cfc4;
                    border-radius: 10px;
                    overflow: hidden;
                }
                .scene-image {
                    max-width: 100%;
                    max-height: 100%;
                    object-fit: contain;
                }
                .scene-image-placeholder {
                    color: #999;
                    font-size: 14px;
                }
                .scene-description-side {
                    flex: 0 0 40%;
                    display: flex;
                    flex-direction: column;
                    background: #f0ebe3;
                    border-radius: 8px;
                    padding: 12px;
                }
                .scene-description-side .field-value {
                    font-size: 14px;
                    line-height: 1.5;
                    color: #3a3632;
                }
                
                /* –ù–∏–∑: –¥–∏–∞–ª–æ–≥ + –∑–∞–º–µ—Ç–∫–∏ */
                .scene-bottom {
                    display: flex;
                    gap: 16px;
                }
                .field-dialogue { flex: 2; }
                .field-notes { flex: 1; }
                
                .field-label {
                    font-size: 10px;
                    font-weight: bold;
                    text-transform: uppercase;
                    color: #6b6560;
                    margin-bottom: 6px;
                }
                .field-value {
                    font-size: 12px;
                    line-height: 1.4;
                }
                .dialogue-text {
                    background: #fffbf5;
                    padding: 12px 16px;
                    border-left: 4px solid #c45a32;
                    border-radius: 0 8px 8px 0;
                    font-style: italic;
                    font-size: 16px;
                    line-height: 1.5;
                    min-height: 80px;
                }
                
                /* –ü—Ä–æ–º–ø—Ç */
                .prompt-row {
                    font-size: 9px;
                    color: #999;
                    border-top: 1px dashed #d4cfc4;
                    padding-top: 8px;
                    margin-top: 8px;
                }

                /* –û–±–ª–æ–∂–∫–∞ - –∫–∞–∫ –≤ –º–∞–∫–µ—Ç–µ */
                .cover-card {
                    border: 3px solid #5a5a4e;
                    border-radius: 16px;
                    background: #f8f5f0;
                    padding: 40px;
                    height: 100%;
                    display: flex;
                    flex-direction: column;
                }
                .cover-card h1 {
                    font-size: 42px;
                    color: #c45a32;
                    margin-bottom: 24px;
                    font-weight: 600;
                }
                .cover-meta {
                    display: flex;
                    gap: 32px;
                    font-size: 16px;
                    color: #6b6560;
                    margin-bottom: 32px;
                    align-items: center;
                }
                .cover-meta .dot {
                    width: 10px;
                    height: 10px;
                    background: #c45a32;
                    border-radius: 50%;
                    display: inline-block;
                    margin-right: 8px;
                }
                .cover-meta .duration-box {
                    background: #f0ebe3;
                    border: 1px solid #d4cfc4;
                    border-radius: 6px;
                    padding: 4px 12px;
                    font-weight: 500;
                }
                .characters-block {
                    background: #fffbf5;
                    border: 2px solid #d4cfc4;
                    border-radius: 12px;
                    padding: 20px;
                    flex: 1;
                }
                .characters-block h3 {
                    font-size: 14px;
                    color: #6b6560;
                    margin-bottom: 16px;
                    font-weight: 600;
                }
                .character-row {
                    background: #f0ebe3;
                    border: 1px solid #d4cfc4;
                    border-radius: 8px;
                    padding: 12px 16px;
                    margin-bottom: 12px;
                    display: flex;
                    gap: 16px;
                    align-items: flex-start;
                }
                .character-row:last-child {
                    margin-bottom: 0;
                }
                .character-label {
                    color: #c45a32;
                    font-weight: 600;
                    font-size: 12px;
                    min-width: 60px;
                }
                .character-name {
                    font-weight: 600;
                    color: #3a3632;
                    min-width: 120px;
                }
                .character-desc {
                    color: #6b6560;
                    font-size: 13px;
                    flex: 1;
                }
            </style></head><body>`;

            // Cover page - –∫–∞–∫ –≤ –º–∞–∫–µ—Ç–µ
            const charactersHtml = characters.length > 0
                ? characters.map((char, i) => `
                    <div class="character-row">
                        <span class="character-label">–ì–µ—Ä–æ–π ${i + 1}</span>
                        <span class="character-name">${char.name || '‚Äî'}</span>
                        <span class="character-desc">${char.description || ''}</span>
                    </div>
                `).join('')
                : '<div style="color: #999; font-style: italic;">–ì–µ—Ä–æ–∏ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</div>';

            html += `<div class="page">
                <div class="cover-card">
                    <h1>${projectTitleEl.value}</h1>
                    <div class="cover-meta">
                        <span><span class="dot"></span>${scenes.length} —Å—Ü–µ–Ω</span>
                        <span><span class="dot"></span><span class="duration-box">${totalDurationEl.value}</span> —Ö—Ä–æ–Ω–æ–º–µ—Ç—Ä–∞–∂</span>
                        <span><span class="dot"></span>–°—Ç–∞—Ç–∏—á–Ω—ã–µ –∫–∞–¥—Ä—ã</span>
                    </div>
                    <div class="characters-block">
                        <h3>üë§ –ì–µ—Ä–æ–∏</h3>
                        ${charactersHtml}
                    </div>
                </div>
            </div>`;

            // Scene pages
            scenes.forEach((s, i) => {
                html += `<div class="page">
                    <div class="scene-card">
                        <!-- –®–∞–ø–∫–∞ -->
                        <div class="scene-header">
                            <span class="scene-badge">–°—Ü–µ–Ω–∞ ${i + 1}</span>
                            <span class="scene-title">${s.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</span>
                            <div class="scene-meta">
                                <span>‚è± ${s.duration || '0:00'}</span>
                                <span>üì∑ ${shotTypes[s.shotType] || '‚Äî'}</span>
                            </div>
                        </div>
                        
                        <!-- –°–µ—Ä–µ–¥–∏–Ω–∞: –∫–∞—Ä—Ç–∏–Ω–∫–∞ + –æ–ø–∏—Å–∞–Ω–∏–µ -->
                        <div class="scene-middle">
                            <div class="scene-image-wrap">
                                ${s.image
                        ? `<img class="scene-image" src="${s.image}">`
                        : `<span class="scene-image-placeholder">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ</span>`
                    }
                            </div>
                            <div class="scene-description-side">
                                <div class="field-label">–û–ø–∏—Å–∞–Ω–∏–µ</div>
                                <div class="field-value">${s.description || '‚Äî'}</div>
                            </div>
                        </div>
                        
                        <!-- –ù–∏–∑: –¥–∏–∞–ª–æ–≥ + –∑–∞–º–µ—Ç–∫–∏ -->
                        <div class="scene-bottom">
                            <div class="field-dialogue">
                                <div class="field-label">–î–∏–∞–ª–æ–≥ / –ó–∞–∫–∞–¥—Ä–æ–≤—ã–π —Ç–µ–∫—Å—Ç</div>
                                <div class="dialogue-text">${s.dialogue ? s.dialogue.replace(/\n/g, '<br>') : '‚Äî'}</div>
                            </div>
                            <div class="field-notes">
                                <div class="field-label">–ó–∞–º–µ—Ç–∫–∏</div>
                                <div class="field-value">${s.notes || '‚Äî'}</div>
                            </div>
                        </div>
                        
                        <!-- –ü—Ä–æ–º–ø—Ç -->
                        ${s.prompt ? `<div class="prompt-row"><strong>–ü—Ä–æ–º–ø—Ç:</strong> ${s.prompt}</div>` : ''}
                    </div>
                </div>`;
            });

            html += `</body></html>`;

            // Open in new window and trigger print
            const printWindow = window.open('', '_blank');
            printWindow.document.write(html);
            printWindow.document.close();
            setTimeout(() => printWindow.print(), 500);
            showToast('–û—Ç–∫—Ä—ã—Ç–æ –æ–∫–Ω–æ PDF');
        }


        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.querySelector('.toast-icon').textContent = '‚úÖ';
            toast.querySelector('.toast-message').textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
    </script>
</body>

</html>